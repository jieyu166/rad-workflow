<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>椎間孔狹窄報告輔助工具</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .spine-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .spine-btn {
            padding: 12px 30px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f0f0f0;
            color: #333;
            font-weight: bold;
        }
        
        .spine-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .spine-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .spine-section {
            display: none;
            margin-bottom: 30px;
        }
        
        .spine-section.active {
            display: block;
        }
        
        .level-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .level-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .level-row:hover {
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .level-label {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #333;
            padding: 8px 16px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-label:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .level-label.disc-narrowing {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        
        .side-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            min-width: 80px;
        }
        
        .side-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .side-btn.mild {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .side-btn.moderate {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .side-btn.severe {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .spondylolisthesis-btn {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
            background: white;
            min-width: 40px;
            color: #333;
        }
        
        .spondylolisthesis-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .spondylolisthesis-btn.grade1 {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .spondylolisthesis-btn.grade2 {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .spondylolisthesis-btn.grade3 {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .spondylolisthesis-btn.grade4 {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        .spondylolisthesis-btn.grade5 {
            background: #e2e3e5;
            border-color: #6c757d;
            color: #383d41;
        }
        
        .retrolisthesis-btn {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s ease;
            background: white;
            min-width: 40px;
            color: #333;
        }
        
        .retrolisthesis-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .retrolisthesis-btn.mild {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .retrolisthesis-btn.moderate {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .retrolisthesis-btn.severe {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
        }
        
        .report-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .report-output {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .copy-btn:active {
            transform: translateY(0);
        }
        
        .clear-btn {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        @media (max-width: 768px) {
            .spine-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .level-row {
                grid-template-columns: 1fr;
                gap: 15px;
                text-align: center;
            }
            
            .level-row > * {
                margin: 5px 0;
            }
            
            .legend {
                flex-direction: column;
                align-items: center;
            }
            
            .spondylolisthesis-btn, .retrolisthesis-btn {
                min-width: 60px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>椎間孔狹窄報告輔助工具</h1>
        
        <div class="spine-selector">
            <button class="spine-btn active" onclick="selectSpine('c-spine')">C-spine</button>
            <button class="spine-btn" onclick="selectSpine('l-spine')">L-spine</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #d4edda; border-color: #28a745;"></div>
                <span>Mild</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3cd; border-color: #ffc107;"></div>
                <span>Moderate</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f8d7da; border-color: #dc3545;"></div>
                <span>Severe</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #d1ecf1; border-color: #17a2b8;"></div>
                <span>Grade 4</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e2e3e5; border-color: #6c757d;"></div>
                <span>Grade 5</span>
            </div>
        </div>
        
        <div id="c-spine" class="spine-section active">
            <div class="level-grid">
                <div class="level-row">
                    <button class="side-btn" data-level="C2/3" data-side="right" onclick="toggleSeverity(this)">右側 C2/3</button>
                    <button class="spondylolisthesis-btn" data-level="C2/3" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C2/3" onclick="toggleDiscNarrowing(this)">C2/3</div>
                    <button class="retrolisthesis-btn" data-level="C2/3" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C2/3" data-side="left" onclick="toggleSeverity(this)">左側 C2/3</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="C3/4" data-side="right" onclick="toggleSeverity(this)">右側 C3/4</button>
                    <button class="spondylolisthesis-btn" data-level="C3/4" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C3/4" onclick="toggleDiscNarrowing(this)">C3/4</div>
                    <button class="retrolisthesis-btn" data-level="C3/4" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C3/4" data-side="left" onclick="toggleSeverity(this)">左側 C3/4</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="C4/5" data-side="right" onclick="toggleSeverity(this)">右側 C4/5</button>
                    <button class="spondylolisthesis-btn" data-level="C4/5" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C4/5" onclick="toggleDiscNarrowing(this)">C4/5</div>
                    <button class="retrolisthesis-btn" data-level="C4/5" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C4/5" data-side="left" onclick="toggleSeverity(this)">左側 C4/5</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="C5/6" data-side="right" onclick="toggleSeverity(this)">右側 C5/6</button>
                    <button class="spondylolisthesis-btn" data-level="C5/6" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C5/6" onclick="toggleDiscNarrowing(this)">C5/6</div>
                    <button class="retrolisthesis-btn" data-level="C5/6" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C5/6" data-side="left" onclick="toggleSeverity(this)">左側 C5/6</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="C6/7" data-side="right" onclick="toggleSeverity(this)">右側 C6/7</button>
                    <button class="spondylolisthesis-btn" data-level="C6/7" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C6/7" onclick="toggleDiscNarrowing(this)">C6/7</div>
                    <button class="retrolisthesis-btn" data-level="C6/7" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C6/7" data-side="left" onclick="toggleSeverity(this)">左側 C6/7</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="C7/T1" data-side="right" onclick="toggleSeverity(this)">右側 C7/T1</button>
                    <button class="spondylolisthesis-btn" data-level="C7/T1" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="C7/T1" onclick="toggleDiscNarrowing(this)">C7/T1</div>
                    <button class="retrolisthesis-btn" data-level="C7/T1" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="C7/T1" data-side="left" onclick="toggleSeverity(this)">左側 C7/T1</button>
                </div>
            </div>
        </div>
        
        <div id="l-spine" class="spine-section">
            <div class="level-grid">
                <div class="level-row">
                    <button class="side-btn" data-level="T12/L1" data-side="right" onclick="toggleSeverity(this)">右側 T12/L1</button>
                    <button class="spondylolisthesis-btn" data-level="T12/L1" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="T12/L1" onclick="toggleDiscNarrowing(this)">T12/L1</div>
                    <button class="retrolisthesis-btn" data-level="T12/L1" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="T12/L1" data-side="left" onclick="toggleSeverity(this)">左側 T12/L1</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="L1/2" data-side="right" onclick="toggleSeverity(this)">右側 L1/2</button>
                    <button class="spondylolisthesis-btn" data-level="L1/2" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="L1/2" onclick="toggleDiscNarrowing(this)">L1/2</div>
                    <button class="retrolisthesis-btn" data-level="L1/2" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="L1/2" data-side="left" onclick="toggleSeverity(this)">左側 L1/2</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="L2/3" data-side="right" onclick="toggleSeverity(this)">右側 L2/3</button>
                    <button class="spondylolisthesis-btn" data-level="L2/3" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="L2/3" onclick="toggleDiscNarrowing(this)">L2/3</div>
                    <button class="retrolisthesis-btn" data-level="L2/3" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="L2/3" data-side="left" onclick="toggleSeverity(this)">左側 L2/3</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="L3/4" data-side="right" onclick="toggleSeverity(this)">右側 L3/4</button>
                    <button class="spondylolisthesis-btn" data-level="L3/4" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="L3/4" onclick="toggleDiscNarrowing(this)">L3/4</div>
                    <button class="retrolisthesis-btn" data-level="L3/4" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="L3/4" data-side="left" onclick="toggleSeverity(this)">左側 L3/4</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="L4/5" data-side="right" onclick="toggleSeverity(this)">右側 L4/5</button>
                    <button class="spondylolisthesis-btn" data-level="L4/5" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="L4/5" onclick="toggleDiscNarrowing(this)">L4/5</div>
                    <button class="retrolisthesis-btn" data-level="L4/5" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="L4/5" data-side="left" onclick="toggleSeverity(this)">左側 L4/5</button>
                </div>
                <div class="level-row">
                    <button class="side-btn" data-level="L5/S1" data-side="right" onclick="toggleSeverity(this)">右側 L5/S1</button>
                    <button class="spondylolisthesis-btn" data-level="L5/S1" data-type="spondylolisthesis" onclick="toggleSpondylolisthesis(this)">S</button>
                    <div class="level-label" data-level="L5/S1" onclick="toggleDiscNarrowing(this)">L5/S1</div>
                    <button class="retrolisthesis-btn" data-level="L5/S1" data-type="retrolisthesis" onclick="toggleRetrolisthesis(this)">R</button>
                    <button class="side-btn" data-level="L5/S1" data-side="left" onclick="toggleSeverity(this)">左側 L5/S1</button>
                </div>
            </div>
        </div>
        
        <div class="report-section">
            <h3>報告輸出</h3>
            <div id="report-output" class="report-output">點選按鈕開始標註...</div>
            <button class="copy-btn" onclick="copyReport()">複製報告</button>
            <button class="clear-btn" onclick="clearAll()">清除全部</button>
        </div>
    </div>

    <script>
        // 儲存選擇狀態
        const selections = {};
        const discNarrowing = {};
        
        // 嚴重程度對應
        const severityLevels = ['', 'mild', 'moderate', 'severe'];
        const severityText = {
            'mild': 'Mild',
            'moderate': 'Moderate', 
            'severe': 'Severe'
        };
        
        // Spondylolisthesis等級對應
        const spondylolisthesisGrades = ['', 'grade1', 'grade2', 'grade3', 'grade4', 'grade5'];
        const spondylolisthesisText = {
            'grade1': 'Grade 1',
            'grade2': 'Grade 2',
            'grade3': 'Grade 3',
            'grade4': 'Grade 4',
            'grade5': 'Grade 5'
        };
        
        // Retrolisthesis嚴重程度對應
        const retrolisthesisLevels = ['', 'mild', 'moderate', 'severe'];
        const retrolisthesisText = {
            'mild': 'Mild',
            'moderate': 'Moderate',
            'severe': 'Severe'
        };
        
        function selectSpine(spineType) {
            // 更新按鈕狀態
            document.querySelectorAll('.spine-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新顯示區域
            document.querySelectorAll('.spine-section').forEach(section => section.classList.remove('active'));
            document.getElementById(spineType).classList.add('active');
            
            // 更新報告
            updateReport();
        }
        
        function toggleSeverity(button) {
            const level = button.dataset.level;
            const side = button.dataset.side;
            const key = `${level}_${side}`;
            
            // 取得目前狀態
            let currentState = selections[key] || 0;
            
            // 循環狀態：0 -> 1 -> 2 -> 3 -> 0
            currentState = (currentState + 1) % 4;
            
            if (currentState === 0) {
                delete selections[key];
                button.className = 'side-btn';
            } else {
                selections[key] = currentState;
                button.className = `side-btn ${severityLevels[currentState]}`;
            }
            
            updateReport();
        }
        
        function toggleSpondylolisthesis(button) {
            const level = button.dataset.level;
            const key = `${level}_spondylolisthesis`;
            
            // 取得目前狀態
            let currentState = selections[key] || 0;
            
            // 循環狀態：0 -> 1 -> 2 -> 3 -> 4 -> 5 -> 0
            currentState = (currentState + 1) % 6;
            
            if (currentState === 0) {
                delete selections[key];
                button.className = 'spondylolisthesis-btn';
            } else {
                selections[key] = currentState;
                button.className = `spondylolisthesis-btn ${spondylolisthesisGrades[currentState]}`;
            }
            
            updateReport();
        }
        
        function toggleRetrolisthesis(button) {
            const level = button.dataset.level;
            const key = `${level}_retrolisthesis`;
            
            // 取得目前狀態
            let currentState = selections[key] || 0;
            
            // 循環狀態：0 -> 1 -> 2 -> 3 -> 0
            currentState = (currentState + 1) % 4;
            
            if (currentState === 0) {
                delete selections[key];
                button.className = 'retrolisthesis-btn';
            } else {
                selections[key] = currentState;
                button.className = `retrolisthesis-btn ${retrolisthesisLevels[currentState]}`;
            }
            
            updateReport();
        }
        
        function toggleDiscNarrowing(label) {
            const level = label.dataset.level;
            
            if (discNarrowing[level]) {
                delete discNarrowing[level];
                label.classList.remove('disc-narrowing');
            } else {
                discNarrowing[level] = true;
                label.classList.add('disc-narrowing');
            }
            
            updateReport();
        }
        
        function updateReport() {
            const reportDiv = document.getElementById('report-output');
            
            const hasAnySelection = Object.keys(selections).length > 0 || Object.keys(discNarrowing).length > 0;
            
            if (!hasAnySelection) {
                reportDiv.textContent = '點選按鈕開始標註...';
                return;
            }
            
            const reports = [];
            
            // 處理神經孔狹窄 (neuroforaminal narrowing)
            const severityGroups = {
                'mild': { bilateral: [], right: [], left: [] },
                'moderate': { bilateral: [], right: [], left: [] },
                'severe': { bilateral: [], right: [], left: [] }
            };
            
            // 先按level分組以處理bilateral情況
            const levelGroups = {};
            Object.entries(selections).forEach(([key, severity]) => {
                const parts = key.split('_');
                if (parts.length === 2 && (parts[1] === 'left' || parts[1] === 'right')) {
                    const [level, side] = parts;
                    if (!levelGroups[level]) {
                        levelGroups[level] = {};
                    }
                    levelGroups[level][side] = severity;
                }
            });
            
            // 處理每個level並分配到嚴重程度組
            Object.entries(levelGroups).forEach(([level, sides]) => {
                const leftSeverity = sides.left || 0;
                const rightSeverity = sides.right || 0;
                
                if (leftSeverity === 0 && rightSeverity === 0) return;
                
                // 檢查是否為bilateral且嚴重程度相同
                if (leftSeverity > 0 && rightSeverity > 0 && leftSeverity === rightSeverity) {
                    const severityName = severityLevels[leftSeverity];
                    severityGroups[severityName].bilateral.push(level);
                } else {
                    // 分別處理左右側
                    if (rightSeverity > 0) {
                        const severityName = severityLevels[rightSeverity];
                        severityGroups[severityName].right.push(level);
                    }
                    
                    if (leftSeverity > 0) {
                        const severityName = severityLevels[leftSeverity];
                        severityGroups[severityName].left.push(level);
                    }
                }
            });
            
            // 生成神經孔狹窄報告
            ['severe', 'moderate', 'mild'].forEach(severity => {
                const group = severityGroups[severity];
                const parts = [];
                
                // bilateral
                if (group.bilateral.length > 0) {
                    parts.push(`bilateral ${group.bilateral.join(', ')}`);
                }
                
                // right side
                if (group.right.length > 0) {
                    parts.push(`right ${group.right.join(', ')}`);
                }
                
                // left side
                if (group.left.length > 0) {
                    parts.push(`left ${group.left.join(', ')}`);
                }
                
                if (parts.length > 0) {
                    const severityName = severityText[severity];
                    reports.push(`- ${severityName} ${parts.join(', ')} neuroforaminal narrowing.`);
                }
            });
            
            // 處理Spondylolisthesis
            const spondylolisthesisGroups = {
                'grade1': [],
                'grade2': [],
                'grade3': [],
                'grade4': [],
                'grade5': []
            };
            
            Object.entries(selections).forEach(([key, grade]) => {
                if (key.endsWith('_spondylolisthesis')) {
                    const level = key.replace('_spondylolisthesis', '');
                    const gradeName = spondylolisthesisGrades[grade];
                    if (gradeName && spondylolisthesisGroups[gradeName]) {
                        spondylolisthesisGroups[gradeName].push(level);
                    }
                }
            });
            
            // 生成Spondylolisthesis報告
            ['grade1', 'grade2', 'grade3', 'grade4', 'grade5'].forEach(grade => {
                if (spondylolisthesisGroups[grade].length > 0) {
                    const levels = spondylolisthesisGroups[grade].join(', ');
                    reports.push(`- ${spondylolisthesisText[grade]} spondylolisthesis of ${levels}.`);
                }
            });
            
            // 處理Retrolisthesis
            const retrolisthesisGroups = {
                'mild': [],
                'moderate': [],
                'severe': []
            };
            
            Object.entries(selections).forEach(([key, severity]) => {
                if (key.endsWith('_retrolisthesis')) {
                    const level = key.replace('_retrolisthesis', '');
                    const severityName = retrolisthesisLevels[severity];
                    if (severityName && retrolisthesisGroups[severityName]) {
                        retrolisthesisGroups[severityName].push(level);
                    }
                }
            });
            
            // 生成Retrolisthesis報告
            ['severe', 'moderate', 'mild'].forEach(severity => {
                if (retrolisthesisGroups[severity].length > 0) {
                    const levels = retrolisthesisGroups[severity].join(', ');
                    reports.push(`- ${retrolisthesisText[severity]} retrolisthesis of ${levels}.`);
                }
            });
            
            // 處理Disc space narrowing
            const discLevels = Object.keys(discNarrowing);
            if (discLevels.length > 0) {
                reports.push(`- ${discLevels.join(', ')} disc space narrowing.`);
            }
            
            reportDiv.textContent = reports.length > 0 ? reports.join('\n') : '點選按鈕開始標註...';
        }
        
        function copyReport() {
            const reportText = document.getElementById('report-output').textContent;
            
            if (reportText === '點選按鈕開始標註...') {
                alert('請先進行標註再複製報告');
                return;
            }
            
            navigator.clipboard.writeText(reportText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '已複製!';
                btn.style.background = 'linear-gradient(45deg, #20c997, #17a2b8)';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                }, 2000);
            }).catch(err => {
                alert('複製失敗，請手動複製文字內容');
            });
        }
        
        function clearAll() {
            if (confirm('確定要清除所有標註嗎？')) {
                // 清除所有選擇
                Object.keys(selections).forEach(key => delete selections[key]);
                Object.keys(discNarrowing).forEach(key => delete discNarrowing[key]);
                
                // 重置所有按鈕
                document.querySelectorAll('.side-btn').forEach(btn => {
                    btn.className = 'side-btn';
                });
                
                document.querySelectorAll('.spondylolisthesis-btn').forEach(btn => {
                    btn.className = 'spondylolisthesis-btn';
                });
                
                document.querySelectorAll('.retrolisthesis-btn').forEach(btn => {
                    btn.className = 'retrolisthesis-btn';
                });
                
                document.querySelectorAll('.level-label').forEach(label => {
                    label.classList.remove('disc-narrowing');
                });
                
                // 更新報告
                updateReport();
            }
        }
    </script>
</body>
</html>
